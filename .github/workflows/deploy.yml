name: Deploy

on:
  push:
    tags:
      - prod/*

permissions:
  id-token: write
  contents: read

jobs:
  serverless:
    name: Upload Extensions
    runs-on: ubuntu-latest # <- was ubuntu-20.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::228067885724:role/GithubActionsRole
          role-session-name: github-actions-${{ github.run_id }}
          aws-region: us-east-1

      - name: Install node modules
        run: yarn install --frozen-lockfile

      - name: Build
        run: yarn build:prod

      - name: Clean up failed CloudFormation stack and change sets
        run: .github/scripts/cleanup-cloudformation-stack.sh "salmon-wallet-app-prod" us-east-1

      - name: Wait for stack cleanup to complete
        run: |
          STACK_NAME="salmon-wallet-app-prod"
          echo "Checking if stack deletion is in progress..."

          if aws cloudformation describe-stacks --stack-name $STACK_NAME --region us-east-1 2>/dev/null; then
            STATUS=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --region us-east-1 --query 'Stacks[0].StackStatus' --output text)
            echo "Stack status: $STATUS"
            
            if [[ "$STATUS" == "DELETE_IN_PROGRESS" ]]; then
              echo "Stack deletion in progress, waiting for completion..."
              aws cloudformation wait stack-delete-complete --stack-name $STACK_NAME --region us-east-1 || echo "Still deleting or timeout"
            fi
          else
            echo "Stack does not exist, ready for fresh deployment"
          fi

      - name: Ensure app bucket exists
        run: .github/scripts/ensure-s3-bucket.sh "salmon-wallet-app-prod" us-east-1

      - name: Publish
        id: deploy
        continue-on-error: true
        run: yarn serverless:deploy --verbose

      - name: Fix deployment error and retry
        if: steps.deploy.outcome == 'failure'
        run: |
          STACK_NAME="salmon-wallet-app-prod"
          echo "First deploy failed, analyzing stack state..."

          if aws cloudformation describe-stacks --stack-name $STACK_NAME --region us-east-1 2>/dev/null; then
            STATUS=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --region us-east-1 --query 'Stacks[0].StackStatus' --output text)
            echo "Stack status: $STATUS"

            # Handle DELETE_FAILED with --retain-resources
            if [[ "$STATUS" == "DELETE_FAILED" ]]; then
              echo "Stack is in DELETE_FAILED state. Using --retain-resources..."
              aws cloudformation delete-stack --stack-name $STACK_NAME --region us-east-1 \
                --retain-resources ServerlessDeploymentBucket 2>/dev/null || \
              aws cloudformation delete-stack --stack-name $STACK_NAME --region us-east-1
              aws cloudformation wait stack-delete-complete --stack-name $STACK_NAME --region us-east-1 || true
              echo "Retrying deployment..."
              yarn serverless:deploy --verbose

            # Handle healthy states
            elif [[ "$STATUS" == "CREATE_COMPLETE" ]] || [[ "$STATUS" == "UPDATE_COMPLETE" ]]; then
              echo "Stack is healthy ($STATUS). Retrying deployment..."
              yarn serverless:deploy --verbose

            # Handle ROLLBACK states
            elif [[ "$STATUS" == *"ROLLBACK"* ]] || [[ "$STATUS" == *"FAILED"* ]]; then
              echo "Stack is in problematic state ($STATUS). Deleting..."
              aws cloudformation delete-stack --stack-name $STACK_NAME --region us-east-1
              aws cloudformation wait stack-delete-complete --stack-name $STACK_NAME --region us-east-1 || true
              echo "Retrying deployment..."
              yarn serverless:deploy --verbose

            else
              echo "Stack is in unexpected state: $STATUS. Attempting deployment anyway..."
              yarn serverless:deploy --verbose
            fi
          else
            echo "Stack does not exist. Retrying deployment..."
            yarn serverless:deploy --verbose
          fi

      - name: Get detailed error information
        if: failure() && steps.deploy.outcome == 'failure'
        run: |
          STACK_NAME="salmon-wallet-app-prod"

          echo "=== Checking if stack exists ==="
          if aws cloudformation describe-stacks --stack-name $STACK_NAME --region us-east-1 2>/dev/null; then
            echo "Stack exists, getting details..."
            aws cloudformation describe-stacks --stack-name $STACK_NAME --region us-east-1 \
              --query 'Stacks[0].{Status:StackStatus,StatusReason:StackStatusReason}' --output table
          else
            echo "Stack does not exist"
          fi

          echo ""
          echo "=== CloudFormation Stack Events (all recent) ==="
          aws cloudformation describe-stack-events \
            --stack-name $STACK_NAME \
            --region us-east-1 \
            --max-items 30 \
            --output table || echo "Could not get stack events"

          echo ""
          echo "=== Stack Resources ==="
          aws cloudformation describe-stack-resources \
            --stack-name $STACK_NAME \
            --region us-east-1 \
            --query 'StackResources[].{LogicalId:LogicalResourceId,PhysicalId:PhysicalResourceId,Type:ResourceType,Status:ResourceStatus}' \
            --output table || echo "Could not get stack resources"

          echo ""
          echo "=== Change Set Details ==="
          CHANGESET_NAME="${STACK_NAME}-change-set"
          if aws cloudformation describe-change-set \
            --stack-name $STACK_NAME \
            --change-set-name $CHANGESET_NAME \
            --region us-east-1 2>/dev/null; then
            echo "Change set exists, getting details..."
            aws cloudformation describe-change-set \
              --stack-name $STACK_NAME \
              --change-set-name $CHANGESET_NAME \
              --region us-east-1 \
              --query '{Status:Status,StatusReason:StatusReason,Changes:Changes[].{Action:Action,Resource:ResourceChange.LogicalResourceId,Type:ResourceChange.ResourceType,Reason:ResourceChange.Replacement}}' \
              --output json | head -100
          else
            echo "Change set does not exist or could not be described"
          fi

          echo ""
          echo "=== Checking for existing resources ==="
          echo "Checking S3 bucket salmon-wallet-app-prod..."
          if aws s3api head-bucket --bucket salmon-wallet-app-prod --region us-east-1 2>/dev/null; then
            echo "✓ Bucket exists"
          else
            echo "✗ Bucket does not exist"
          fi

          echo ""
          echo "Checking CloudFront distributions..."
          aws cloudfront list-distributions \
            --query "DistributionList.Items[?contains(Comment, 'Salmon Wallet') || contains(Comment, 'prod')].{Id:Id,DomainName:DomainName,Status:Status,Comment:Comment}" \
            --output table || echo "Error checking CloudFront"

          echo ""
          echo "=== Checking for other CloudFormation stacks ==="
          aws cloudformation list-stacks \
            --stack-status-filter CREATE_FAILED UPDATE_FAILED DELETE_FAILED ROLLBACK_COMPLETE \
            --region us-east-1 \
            --query "StackSummaries[?contains(StackName, 'salmon-wallet')].{Name:StackName,Status:StackStatus}" \
            --output table 2>/dev/null || echo "Error listing stacks (non-critical)"

          echo ""
          echo "=== Recommendation ==="
          echo "If the error persists, the stack may need to be manually deleted."
          echo "The stack appears to be in an inconsistent state where it exists"
          echo "but CloudFormation cannot create resources due to ResourceExistenceCheck."

          exit 1

      - name: Build extensions
        run: yarn build:extension

      - name: Upload bundle into S3
        run: yarn upload:bundle

      - name: Invalidate CloudFront cache
        continue-on-error: true
        run: |
          echo "Invalidating CloudFront distribution cache..."
          aws cloudfront create-invalidation \
            --distribution-id E2NZ6X31C2VZEL \
            --paths "/*" \
            && echo "CloudFront cache invalidation initiated successfully" \
            || echo "Warning: CloudFront cache invalidation failed, but deployment was successful"
