name: Deploy

on:
  push:
    tags:
      - prod/*

permissions:
  id-token: write
  contents: read

jobs:
  serverless:
    name: Upload Extensions
    runs-on: ubuntu-latest # <- was ubuntu-20.04

    steps:
      - name: Inject slug/short variables
        uses: rlespinasse/github-slug-action@v3

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.4'
          check-latest: true
          cache: 'yarn'

      - name: Verify Node.js version
        run: node --version && yarn --version

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::228067885724:role/GithubActionsRole
          aws-region: us-east-1

      - name: Install node modules
        run: yarn install --frozen-lockfile

      - name: Build
        run: yarn build:prod

      - name: Clean up failed CloudFormation stack and change sets
        run: |
          STACK_NAME="salmon-wallet-app-prod"
          echo "Checking CloudFormation stack status..."

          if aws cloudformation describe-stacks --stack-name $STACK_NAME --region us-east-1 2>/dev/null; then
            STATUS=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --region us-east-1 --query 'Stacks[0].StackStatus' --output text)
            echo "Stack exists with status: $STATUS"
            
            # Handle DELETE_FAILED state - need to clean up resources manually
            if [[ "$STATUS" == "DELETE_FAILED" ]]; then
              echo "Stack is in DELETE_FAILED state. Cleaning up resources manually..."
              
              # Get resources that failed to delete
              FAILED_RESOURCES=$(aws cloudformation describe-stack-resources \
                --stack-name $STACK_NAME \
                --region us-east-1 \
                --query 'StackResources[?ResourceStatus==`DELETE_FAILED`].{LogicalId:LogicalResourceId,PhysicalId:PhysicalResourceId,Type:ResourceType}' \
                --output json 2>/dev/null || echo "[]")
              
              echo "Failed resources: $FAILED_RESOURCES"
              
              # Get the ServerlessDeploymentBucket name
              BUCKET_NAME=$(aws cloudformation describe-stack-resources \
                --stack-name $STACK_NAME \
                --region us-east-1 \
                --query 'StackResources[?LogicalResourceId==`ServerlessDeploymentBucket`].PhysicalResourceId' \
                --output text 2>/dev/null || echo "")

              if [ -n "$BUCKET_NAME" ]; then
                echo "Found ServerlessDeploymentBucket: $BUCKET_NAME"

                # Delete bucket policy first
                echo "Deleting bucket policy..."
                aws s3api delete-bucket-policy --bucket "$BUCKET_NAME" --region us-east-1 2>/dev/null || echo "Could not delete bucket policy (may not exist)"

                # Empty the bucket (this is the key step that was missing!)
                echo "Emptying bucket contents..."
                aws s3 rm "s3://$BUCKET_NAME" --recursive --region us-east-1 2>/dev/null || echo "Could not empty bucket (may already be empty)"

                # Handle versioned objects if bucket has versioning
                echo "Removing any versioned objects..."
                aws s3api list-object-versions --bucket "$BUCKET_NAME" --region us-east-1 --output json 2>/dev/null | \
                  jq -r '.Versions[]?, .DeleteMarkers[]? | "--key \"\(.Key)\" --version-id \"\(.VersionId)\""' 2>/dev/null | \
                  while read -r args; do
                    if [ -n "$args" ]; then
                      eval aws s3api delete-object --bucket "$BUCKET_NAME" --region us-east-1 $args 2>/dev/null || true
                    fi
                  done || echo "No versioned objects to delete"

                echo "Bucket cleanup completed"
              fi

              # Now try to continue stack deletion
              echo "Retrying stack deletion..."
              aws cloudformation delete-stack --stack-name $STACK_NAME --region us-east-1
              echo "Waiting for stack deletion..."
              aws cloudformation wait stack-delete-complete --stack-name $STACK_NAME --region us-east-1 || echo "Stack deletion may still be in progress"
            fi
            
            # Delete all failed/pending change sets
            echo "Cleaning up change sets..."
            CHANGESETS=$(aws cloudformation list-change-sets \
              --stack-name $STACK_NAME \
              --region us-east-1 \
              --query 'Summaries[?Status==`FAILED` || Status==`UNAVAILABLE`].ChangeSetName' \
              --output text 2>/dev/null || echo "")
            
            if [ -n "$CHANGESETS" ]; then
              for CS in $CHANGESETS; do
                echo "Deleting change set: $CS"
                aws cloudformation delete-change-set \
                  --stack-name $STACK_NAME \
                  --change-set-name "$CS" \
                  --region us-east-1 2>/dev/null || true
              done
            fi
            
            # Check if stack is in a state that prevents updates
            if [[ "$STATUS" == *"FAILED"* ]] || \
               [[ "$STATUS" == *"ROLLBACK"* ]] || \
               [[ "$STATUS" == "CREATE_FAILED" ]] || \
               [[ "$STATUS" == "ROLLBACK_COMPLETE" ]] || \
               [[ "$STATUS" == "UPDATE_ROLLBACK_COMPLETE" ]] || \
               [[ "$STATUS" == "UPDATE_ROLLBACK_FAILED" ]] || \
               [[ "$STATUS" == "REVIEW_IN_PROGRESS" ]]; then
              if [[ "$STATUS" != "DELETE_FAILED" ]]; then
                echo "Stack is in problematic state ($STATUS), deleting..."
                aws cloudformation delete-stack --stack-name $STACK_NAME --region us-east-1
                echo "Waiting for stack deletion (this may take a few minutes)..."
                aws cloudformation wait stack-delete-complete --stack-name $STACK_NAME --region us-east-1 || echo "Stack deletion may still be in progress, continuing..."
              fi
            elif [[ "$STATUS" == "CREATE_COMPLETE" ]] || [[ "$STATUS" == "UPDATE_COMPLETE" ]]; then
              echo "Stack exists and is complete. Checking resources..."
              # Check if stack actually has resources or is empty
              RESOURCE_COUNT=$(aws cloudformation describe-stack-resources \
                --stack-name $STACK_NAME \
                --region us-east-1 \
                --query 'length(StackResources[])' \
                --output text 2>/dev/null || echo "0")
              
              if [ "$RESOURCE_COUNT" == "0" ] || [ -z "$RESOURCE_COUNT" ]; then
                echo "Stack exists but has no resources. Deleting for fresh deployment..."
                aws cloudformation delete-stack --stack-name $STACK_NAME --region us-east-1
                aws cloudformation wait stack-delete-complete --stack-name $STACK_NAME --region us-east-1 || echo "Stack deletion in progress"
              else
                echo "Stack has $RESOURCE_COUNT resources. Will attempt to update."
              fi
            else
              echo "Stack is in state: $STATUS - deleting to allow fresh deployment"
              aws cloudformation delete-stack --stack-name $STACK_NAME --region us-east-1
              aws cloudformation wait stack-delete-complete --stack-name $STACK_NAME --region us-east-1 || echo "Stack deletion in progress"
            fi
          else
            echo "Stack does not exist"
          fi

      - name: Clean up CloudFront distributions (if orphaned)
        run: |
          echo "Checking for CloudFront distributions related to this stack..."
          DISTRIBUTIONS=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?contains(Comment, 'Salmon Wallet - prod') || contains(Comment, 'salmon-wallet-prod')].Id" \
            --output text --region us-east-1 2>/dev/null || echo "")

          if [ -n "$DISTRIBUTIONS" ]; then
            echo "Found CloudFront distributions: $DISTRIBUTIONS"
            for DIST_ID in $DISTRIBUTIONS; do
              echo "Checking distribution: $DIST_ID"
              STATUS=$(aws cloudfront get-distribution --id "$DIST_ID" --query 'Distribution.Status' --output text --region us-east-1 2>/dev/null || echo "Unknown")
              echo "Distribution $DIST_ID status: $STATUS"
              
              if [ "$STATUS" == "Deployed" ]; then
                echo "Distribution is deployed. Note: CloudFront distributions must be disabled before deletion."
                echo "This distribution will be cleaned up when the CloudFormation stack is deleted."
              fi
            done
          else
            echo "No CloudFront distributions found for this stack"
          fi

          # Also check if there are any distributions pointing to the S3 bucket
          echo ""
          echo "Checking for distributions pointing to salmon-wallet-prod bucket..."
          ALL_DISTS=$(aws cloudfront list-distributions --query 'DistributionList.Items[].Id' --output text --region us-east-1 2>/dev/null || echo "")
          if [ -n "$ALL_DISTS" ]; then
            for DIST_ID in $ALL_DISTS; do
              ORIGIN=$(aws cloudfront get-distribution-config --id "$DIST_ID" --query 'DistributionConfig.Origins.Items[0].DomainName' --output text --region us-east-1 2>/dev/null || echo "")
              if [[ "$ORIGIN" == *"salmon-wallet-prod"* ]]; then
                echo "Found distribution $DIST_ID pointing to salmon-wallet-prod bucket"
              fi
            done
          fi

      - name: Wait for stack cleanup to complete
        run: |
          STACK_NAME="salmon-wallet-app-prod"
          echo "Checking if stack deletion is in progress..."

          if aws cloudformation describe-stacks --stack-name $STACK_NAME --region us-east-1 2>/dev/null; then
            STATUS=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --region us-east-1 --query 'Stacks[0].StackStatus' --output text)
            echo "Stack status: $STATUS"
            
            if [[ "$STATUS" == "DELETE_IN_PROGRESS" ]]; then
              echo "Stack deletion in progress, waiting for completion..."
              aws cloudformation wait stack-delete-complete --stack-name $STACK_NAME --region us-east-1 || echo "Still deleting or timeout"
            fi
          else
            echo "Stack does not exist, ready for fresh deployment"
          fi

      - name: Clean up orphaned S3 bucket
        run: |
          BUCKET_NAME="salmon-wallet-prod"
          echo "Checking S3 bucket..."
          if aws s3api head-bucket --bucket $BUCKET_NAME --region us-east-1 2>/dev/null; then
            echo "Bucket exists, attempting to empty and delete..."
            # Empty the bucket first
            aws s3 rm s3://$BUCKET_NAME --recursive --region us-east-1 || true
            # Try to delete the bucket
            aws s3 rb s3://$BUCKET_NAME --region us-east-1 || echo "Bucket deletion failed (may be in use by CloudFront or have versioning enabled)"
          else
            echo "Bucket does not exist"
          fi

      - name: Publish
        id: deploy
        continue-on-error: true
        run: yarn serverless:deploy --verbose

      - name: Fix ResourceExistenceCheck error and retry
        if: steps.deploy.outcome == 'failure'
        run: |
          STACK_NAME="salmon-wallet-app-prod"

          # Check if the error log contains ResourceExistenceCheck
          echo "Checking if error is ResourceExistenceCheck related..."

          # Check stack status to determine if we need to delete it
          if aws cloudformation describe-stacks --stack-name $STACK_NAME --region us-east-1 2>/dev/null; then
            STATUS=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --region us-east-1 --query 'Stacks[0].StackStatus' --output text)
            RESOURCE_COUNT=$(aws cloudformation describe-stack-resources \
              --stack-name $STACK_NAME \
              --region us-east-1 \
              --query 'length(StackResources[])' \
              --output text 2>/dev/null || echo "0")
            
            echo "Stack status: $STATUS, Resources: $RESOURCE_COUNT"

            # If stack is in a healthy state (CREATE_COMPLETE or UPDATE_COMPLETE), just retry deploy
            if [[ "$STATUS" == "CREATE_COMPLETE" ]] || [[ "$STATUS" == "UPDATE_COMPLETE" ]]; then
              echo "Stack is in healthy state ($STATUS). Retrying deployment (will update existing stack)..."
              yarn serverless:deploy --verbose
            # If stack has no resources, delete it and retry
            elif [ "$RESOURCE_COUNT" == "0" ]; then
              echo "Stack exists but has no resources. Deleting for fresh deployment..."
              aws cloudformation delete-stack --stack-name $STACK_NAME --region us-east-1
              echo "Waiting for stack deletion..."
              aws cloudformation wait stack-delete-complete --stack-name $STACK_NAME --region us-east-1 || echo "Stack deletion in progress"

              echo "Retrying deployment after stack cleanup..."
              yarn serverless:deploy --verbose
            else
              echo "Stack is in state $STATUS with $RESOURCE_COUNT resources. Manual intervention may be needed."
            fi
          else
            echo "Stack does not exist. Deploy should have worked."
          fi

      - name: Get detailed error information
        if: failure() && steps.deploy.outcome == 'failure'
        run: |
          STACK_NAME="salmon-wallet-app-prod"

          echo "=== Checking if stack exists ==="
          if aws cloudformation describe-stacks --stack-name $STACK_NAME --region us-east-1 2>/dev/null; then
            echo "Stack exists, getting details..."
            aws cloudformation describe-stacks --stack-name $STACK_NAME --region us-east-1 \
              --query 'Stacks[0].{Status:StackStatus,StatusReason:StackStatusReason}' --output table
          else
            echo "Stack does not exist"
          fi

          echo ""
          echo "=== CloudFormation Stack Events (all recent) ==="
          aws cloudformation describe-stack-events \
            --stack-name $STACK_NAME \
            --region us-east-1 \
            --max-items 30 \
            --output table || echo "Could not get stack events"

          echo ""
          echo "=== Stack Resources ==="
          aws cloudformation describe-stack-resources \
            --stack-name $STACK_NAME \
            --region us-east-1 \
            --query 'StackResources[].{LogicalId:LogicalResourceId,PhysicalId:PhysicalResourceId,Type:ResourceType,Status:ResourceStatus}' \
            --output table || echo "Could not get stack resources"

          echo ""
          echo "=== Change Set Details ==="
          CHANGESET_NAME="${STACK_NAME}-change-set"
          if aws cloudformation describe-change-set \
            --stack-name $STACK_NAME \
            --change-set-name $CHANGESET_NAME \
            --region us-east-1 2>/dev/null; then
            echo "Change set exists, getting details..."
            aws cloudformation describe-change-set \
              --stack-name $STACK_NAME \
              --change-set-name $CHANGESET_NAME \
              --region us-east-1 \
              --query '{Status:Status,StatusReason:StatusReason,Changes:Changes[].{Action:Action,Resource:ResourceChange.LogicalResourceId,Type:ResourceChange.ResourceType,Reason:ResourceChange.Replacement}}' \
              --output json | head -100
          else
            echo "Change set does not exist or could not be described"
          fi

          echo ""
          echo "=== Checking for existing resources ==="
          echo "Checking S3 bucket salmon-wallet-prod..."
          if aws s3api head-bucket --bucket salmon-wallet-prod --region us-east-1 2>/dev/null; then
            echo "✓ Bucket exists"
          else
            echo "✗ Bucket does not exist"
          fi

          echo ""
          echo "Checking CloudFront distributions..."
          aws cloudfront list-distributions \
            --query "DistributionList.Items[?contains(Comment, 'Salmon Wallet') || contains(Comment, 'prod')].{Id:Id,DomainName:DomainName,Status:Status,Comment:Comment}" \
            --output table || echo "Error checking CloudFront"

          echo ""
          echo "=== Checking for other CloudFormation stacks ==="
          aws cloudformation list-stacks \
            --stack-status-filter CREATE_FAILED UPDATE_FAILED DELETE_FAILED ROLLBACK_COMPLETE \
            --region us-east-1 \
            --query "StackSummaries[?contains(StackName, 'salmon-wallet')].{Name:StackName,Status:StackStatus}" \
            --output table 2>/dev/null || echo "Error listing stacks (non-critical)"

          echo ""
          echo "=== Recommendation ==="
          echo "If the error persists, the stack may need to be manually deleted."
          echo "The stack appears to be in an inconsistent state where it exists"
          echo "but CloudFormation cannot create resources due to ResourceExistenceCheck."

          exit 1

      - name: Build extensions
        run: yarn build:extension

      - name: Upload bundle into S3
        run: yarn upload:bundle

      - name: Invalidate CloudFront cache
        continue-on-error: true
        run: |
          echo "Invalidating CloudFront distribution cache..."
          aws cloudfront create-invalidation \
            --distribution-id E2NZ6X31C2VZEL \
            --paths "/*" \
            && echo "CloudFront cache invalidation initiated successfully" \
            || echo "Warning: CloudFront cache invalidation failed, but deployment was successful"
